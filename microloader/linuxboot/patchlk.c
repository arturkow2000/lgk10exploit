#include <linuxboot/types.h>
#include <lk/api.h>

void secure_boot_disable(void)
{
    /**((uint16_t*)0x46026B1E) = 0xBF00;
    *((uint16_t*)0x46026B28) = 0xBF00;
    *((uint16_t*)0x46026AFA) = 0xBF00;
    *((uint16_t*)0x46026B04) = 0xBF00;
    *((uint16_t*)0x46026B0E) = 0xBF00;
    *((uint16_t*)0x46026B1E) = 0xBF00;*/

    *((uint16_t *)0x4605B8EC) = 0xF04F;
    *((uint16_t *)0x4605B8EC + 2) = 0x0;
    *((uint16_t *)0x4605B8EC + 4) = 0x4770;
}

void patch_lk(void)
{
    secure_boot_disable();

    // patches to aid in debugging

    // trap at infinite loop after "decompress kernel image fail ..."
    *((uint16_t *)0x46027EFC) = 0xFFFF;
    // trap at infinite loop after "can't find device tree ..."
    *((uint16_t *)0x46027ED2) = 0xFFFF;
    // trap at infinite loop after "root node search failed ..."
    *((uint16_t *)0x460290A0) = 0xFFFF;
    // trap at infinite loop after "add subnode memory failed ..."
    *((uint16_t *)0x46029096) = 0xFFFF;
    // trap at infinite loop after "/memory node does not exist ..."
    *((uint16_t *)0x46029030) = 0xFFFF;
    // trap at infinite loop after "64 bit kernel can't boot at ..."
    *((uint16_t *)0x46027F28) = 0xFFFF;

    // trap after "booting linux @ %p ..." (for debugging)
    // *((uint16_t*)0x46028720) = 0xFFFF;

    // 0x46000000 - LK start
    // 0x4605C1D8 - approximate end of LK code segment
    arch_clean_invalidate_cache_range(0x46000000, 0x4605C1D8 - 0x46000000);
    // invalidate ICACHE
    // TODO: verify if is that correct
    __asm__ __volatile__("mcr p15, 0, r12, c7, c5, 0" ::
                             : "r12");
}