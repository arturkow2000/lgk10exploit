ENABLE_UART ?=
QUIET ?= yes

CC := arm-none-eabi-gcc
AS := arm-none-eabi-as
LD := arm-none-eabi-gcc
OBJCOPY := arm-none-eabi-objcopy

CFLAGS := -Iinclude -Idrivers/include -std=gnu99 -Os -mthumb -mcpu=cortex-a9 -fno-builtin-printf -fno-strict-aliasing -fno-builtin-memcpy -mno-unaligned-access -DPRINTF_DISABLE_SUPPORT_FLOAT=1 \
	-DCONFIG_MTK_PMIC_NEW_ARCH -DCONFIG_MTK_PMIC_CHIP_MT6353 -DCONFIG_U3_PHY_AHB_SUPPORT -DCONFIG_LGE_PM -DCONFIG_PROJECT_PHY \
	-DCONFIG_MTK_UART_USB_SWITCH
LDFLAGS := -T linker.x -nodefaultlibs -nostdlib

BUILD_DIR := ./build

TARGET := payload

C_SRC := main.c patchlk.c
C_SRC += libc/memset.c libc/memcpy.c
	
ifeq ($(ENABLE_UART),yes)
CFLAGS += -DLINUXBOOT_ENABLE_UART
C_SRC += uart.c
endif

ifeq ($(QUIET), yes)
CFLAGS += -DLINUXBOOT_QUIET
endif


ASM_SRC = start.S jump.S

OBJ = $(C_SRC:%.c=$(BUILD_DIR)/%.o) $(ASM_SRC:%.S=$(BUILD_DIR)/%.o)
DEP = $(OBJ:%.o=%.d)

$(BUILD_DIR)/$(TARGET).bin: $(BUILD_DIR)/$(TARGET).elf
	$(OBJCOPY) -O binary $^ $@

$(BUILD_DIR)/$(TARGET).elf: $(OBJ)
	$(LD) -o $@ $^ $(LDFLAGS) -lgcc

-include $(DEP)

$(BUILD_DIR)/%.o: %.c
	mkdir -p $(@D)
	$(CC) -MMD -c -o $@ $< $(CFLAGS)

$(BUILD_DIR)/%.o: %.S
	mkdir -p $(@D)
	$(AS) -o $@ $<

clean:
	-rm -rf $(BUILD_DIR)
