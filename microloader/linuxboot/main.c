#include <linuxboot/types.h>
#include <linuxboot/libc.h>
#include <lk/api.h>
#include "bootimg.h"

#include <drivers.h>

// 0x46900000

uint32_t g_boot, g_recovery;
int (*read_org)(part_dev_t *dev, uint64_t src, void *dst, int size, unsigned int part_id);

int read(part_dev_t *dev, uint64_t block_off, void *dst, int sz, unsigned int part_id)
{
    dprintf("read_hook 0x%08X from 0x%08X\n", read_org, __builtin_return_address(0));
#ifndef LINUXBOOT_QUIET
    video_printf("read_hook 0x%08X from 0x%08X\n", read_org, __builtin_return_address(0));
#endif

    int ret = 0;
    if (block_off == g_boot * 0x200 || block_off == g_recovery * 0x200)
    {
#ifndef LINUXBOOT_QUIET
        video_printf("demangle boot image - from 0x%08X\n", __builtin_return_address(0));
#endif

        if (sz < 0x400)
        {
            ret = read_org(dev, block_off + 0x400, dst, sz, part_id);
        }
        else
        {
            void *second_copy = (char *)dst + 0x400;
            ret = read_org(dev, block_off, dst, sz, part_id);
            memcpy(dst, second_copy, 0x400);
            memset(second_copy, 0, 0x400);
        }
    }
    else
    {
        ret = read_org(dev, block_off, dst, sz, part_id);
    }

    return ret;
}

void patch_lk(void);
void enable_uart(void);
void main(void)
{
#ifndef LINUXBOOT_QUIET
    video_printf("hello from linuxboot\n");
#endif
    dprintf("hello from linuxboot\n");

    part_dev_t *dev = mt_part_get_device();
    read_org = dev->read;
    dev->read = read;

    part_t *boot = mt_part_get_partition("boot");
    if (boot)
    {
        g_boot = boot->start_sect;
    }
    else
    {
#ifndef LINUXBOOT_QUIET
        video_printf("boot partition not found\n");
#endif
        g_boot = 0xFFFFFFFF;
    }

    part_t *recovery = mt_part_get_partition("recovery");
    if (recovery)
    {
        g_recovery = boot->start_sect;
    }
    else
    {
#ifndef LINUXBOOT_QUIET
        video_printf("recovery partition not found\n");
        g_recovery = 0xFFFFFFFF;
#endif
    }

    uint32_t *g_boot_mode = (uint32_t *)0x4609D120;
#ifndef LINUXBOOT_QUIET
    video_printf("boot mode = %d\n", *g_boot_mode);
#endif

    //((uint32_t*)0x4609D120)[0] = 2; // force recovery boot

    patch_lk();

    uint32_t *g_boot_hdr = (uint32_t *)0x46120A9C;
    *g_boot_hdr = 0;

#ifndef LINUXBOOT_QUIET
    video_printf("Loading DTB ... ");
#endif
    switch (*g_boot_mode)
    {
    case 0:
        bldr_load_dtb("boot");
        break;
    case 2:
        bldr_load_dtb("recovery");
        break;

    default:
        video_printf("Unknown boot mode (%d): doing normal boot", *g_boot_mode);
        *g_boot_mode = 0;
        bldr_load_dtb("boot");
        break;
    }
#ifndef LINUXBOOT_QUIET
    video_printf("DONE\n");
#endif

#ifdef LINUXBOOT_ENABLE_UART
    enable_uart();
#endif
    mt_boot_init();
    for (;;)
        ;
}
